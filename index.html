<html> 
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<title>National Library of Scotland: Maps API</title>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&region=GB"></script>
<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script type="text/javascript" src="http://nls.tileserver.com/api-cluster.js"></script>
<script type="text/javascript">

function permalink() {
     var url = document.location.toString();
     if (url.indexOf('?') != -1) { url = url.substring(0,url.indexOf('?'))}; 
	document.location.href= url + "?lat=" + map.getCenter().lat() +"&lng="+ map.getCenter().lng()+"&zoom="+map.getZoom();
}

function getURLParam( name ) {
   var regex = new RegExp( "[\\?&]"+name+"=([^&#]*)" );
   var results = regex.exec( window.location.href );
   if( results == null )
     return "";
   else
     return results[1];
}

var param_q = getURLParam("q");
var param_lat = getURLParam("lat");
var param_lng = getURLParam("lng");
var param_zoom = getURLParam("zoom");
 
var map;

function initialize() {

	var map_zoom = 5;
	var map_center = new google.maps.LatLng(54.699234,-2.834473);
	var geocoder;
	
	var gbbounds = new google.maps.LatLngBounds(
		new google.maps.LatLng(49.795450,-9.272461),
		new google.maps.LatLng(60.898388, 2.746582) );

	if (param_lat && param_lng) {
		map_center = new google.maps.LatLng(param_lat, param_lng);
	} else if (param_q == 'auto') {
		// W3C Geolocation provided by modern browsers
		if (typeof(navigator.geolocation) != 'undefined') {
			geocoder = "NODISPLAY";
			navigator.geolocation.getCurrentPosition(function(position) {
				var lat = position.coords.latitude;
				var lng = position.coords.longitude;
				var center = new google.maps.LatLng(lat, lng);
				if (gbbounds.contains(center)) {
					map_center = center;
					map_zoom = 13;
					initialize_map(map_zoom, map_center);
				} else {
					initialize_map(map_zoom, map_center);
				}
			});
		// ClientLocation filled in by the Google loader
		} else if (google.loader.ClientLocation) {
	      var center = new google.maps.LatLng(
			google.loader.ClientLocation.latitude,
			google.loader.ClientLocation.longitude );
		  if (gbbounds.contains(center)) {
			map_center = center;
			map_zoom = 13;
		  }
	    };
	} else if (param_q) {
		geocoder = new google.maps.Geocoder();
	    if (geocoder) {
	      geocoder.geocode( { 'address': param_q+",UK", 'region':"UK" }, function(results, status) {
	        if (status == google.maps.GeocoderStatus.OK) {
				if (param_zoom) map_zoom = parseInt(param_zoom);
				map_center = results[0].geometry.viewport.getCenter();
				initialize_map( map_zoom, map_center, results[0].geometry.viewport, true );
			} else {
				if (param_zoom) map_zoom = parseInt(param_zoom);
				initialize_map(map_zoom, map_center);
			}
	      });
	    }
	}
	if (param_zoom) map_zoom = parseInt(param_zoom);

	// Initialize map only if we are not searching via GeoCoder
	if (!geocoder) {
		initialize_map(map_zoom, map_center);
	}
	
    // Disable right click context menu
    document.getElementById('nlslogo')['oncontextmenu'] = function() { return false; };
    document.getElementById('klokantechlogo')['oncontextmenu'] = function() { return false; };

    // Disable selection
    function disableSelection(target){
        if (typeof target['onselectstart']!="undefined") //IE
                target['onselectstart']=function(){return false}
        else if (typeof target['style']['MozUserSelect']!="undefined") //Firefox
                target['style']['MozUserSelect']="none"
        else //All other route (ie: Opera)
                target['onmousedown']=function(){return false}
                target['style']['cursor'] = "default"
        }
    disableSelection(document.getElementById('nlslogo'));
    disableSelection(document.getElementById('klokantechlogo'));
    disableSelection(document.getElementById('nlsmaptext'));
}

function initialize_map(map_zoom, map_center, map_viewport) {

	if (map_viewport) map_zoom = 13; // zoom in by default for initialization of Geocoder results

    var mapOptions = {
     backgroundColor: '#cedfe4',
     zoom: map_zoom,
     center: map_center,
     streetViewControl: false,
     mapTypeControl: false,
     zoomControl: true,
     zoomControlOptions: {
        position: google.maps.ControlPosition.LEFT_TOP
     },
     mapTypeControlOptions: {
      mapTypeIds: ['historic', google.maps.MapTypeId.ROADMAP, google.maps.MapTypeId.SATELLITE, google.maps.MapTypeId.HYBRID, google.maps.MapTypeId.TERRAIN],
      style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
     }
    };

    map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
	
	if (map_viewport) {
		map.fitBounds(map_viewport);
	}


	// TODO: Automatic load balancing & server availability test:
	// add <img src="testtile" onLoad="win()"> and decide which from available servers is fastest for the client
	var nlsmap = new google.maps.ImageMapType({
	   getTileUrl: function(tile, zoom) { return NLSTileUrlOS(tile.x, tile.y, zoom); },
	   tileSize: new google.maps.Size(256, 256),
	   isPng: false,
	   maxZoom: 14,
	   minZoom: 1,
	   name: 'Historic',
	   alt: "NLS Historic Map"
	});

    // map.setCenter(new google.maps.LatLng(54.699234,-2.834473));
    // map.setZoom(7);
    map.mapTypes.set('historic',nlsmap);
    map.setMapTypeId('historic');
  }

</script> 
</head> 
<body style="margin:0px; padding:0px;" onload="initialize()">
  <div id="map_canvas" style="width:100%; height:100%"></div>

<a href="http://www.nls.uk/" target="_blank" id="nlslogo" style="-webkit-user-select:none; display:block;position:absolute;bottom:23;right:2;z-index:1000;"><img src="nls70-nq8.png" width="70" height="41" border="0" alt="National Library of Scotland" /></a>

<a href="http://www.klokantech.com/" target="_blank" id="klokantechlogo" style="-webkit-user-select: none; display:block;position:absolute;bottom:14;right:2;z-index:1000;"><img src="klokantech70-nq8.png" width="70" height="11" border="0" alt="KlokanTech.com" /></a>

<div id="nlsmaptext" style=" -webkit-user-select: none; position: absolute; bottom: 0px; right:70; color:black;font-family: Arial, sans-serif; font-size:11px; white-space: nowrap; text-align: right; padding:2px;">Historical maps from 1919-47 <a href="http://geo.nls.uk/maps/api/" target="_blank">NLS Maps API</a> - </div>

</body>
</html>
